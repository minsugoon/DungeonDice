<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dungeon Dice (ë˜ì „ ë‹¤ì´ìŠ¤) - í™©ê¸ˆ ë°¸ëŸ°ìŠ¤ ì—ë””ì…˜</title>
  <style>
    :root{
      --bg:#1a1015;
      --panel:#25181e;
      --text:#e4dcd5;
      --accent:#ff5e5e; /* Red/Danger */
      --gold:#ffd700;
      --ok:#44d19d;
      --muted:#8c7b85;
      --line:rgba(255,255,255,.12);
      --shadow:0 8px 24px rgba(0,0,0,.5);
      
      /* Player Colors */
      --p1:#ff6b6b; 
      --p2:#4ecdc4;
      --p3:#ffe66d;
      --p4:#c7f464;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px;min-height:100vh;}
    header{display:flex;justify-content:space-between;align-items:center;background:var(--panel);padding:16px;border-radius:12px;border:1px solid var(--line);}
    h1{margin:0;font-size:20px;color:var(--gold);text-shadow:0 2px 4px rgba(0,0,0,0.5);}
    .status-badge{background:rgba(0,0,0,0.3);padding:4px 12px;border-radius:20px;font-size:13px;color:var(--muted);}

    .main-grid{display:grid;grid-template-columns: minmax(300px, 1fr) 340px; gap:16px; flex:1;}
    @media (max-width: 800px){ .main-grid{grid-template-columns: 1fr;} }

    /* Panels */
    .panel{background:var(--panel);border-radius:16px;border:1px solid var(--line);padding:16px;display:flex;flex-direction:column;}
    .panel-hd{font-weight:700;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:14px;}
    
    /* Board */
    .board-container{flex:1;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,0.2);border-radius:12px;padding:10px;overflow:auto;}
    .board{
      display:grid;
      grid-template-columns:repeat(5, 80px);
      grid-template-rows:repeat(5, 80px);
      gap:8px;
    }
    .tile{
      width:80px;height:80px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      position:relative;
      cursor:pointer;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      transition: all 0.2s;
      user-select:none;
    }
    .tile.start{border-color:var(--ok);background:rgba(68,209,157,0.1);}
    .tile.exit{border-color:var(--gold);background:rgba(255,215,0,0.1);}
    .tile.movable{box-shadow:inset 0 0 0 2px var(--ok);background:rgba(68,209,157,0.15);cursor:pointer;}
    .tile:hover{transform:scale(1.02);z-index:2;}
    
    .t-label{font-size:10px;color:var(--muted);position:absolute;top:4px;width:100%;text-align:center;}
    .t-name{font-size:11px;font-weight:700;text-align:center;line-height:1.1;padding:0 4px; word-break: keep-all;}
    .t-tokens{
      position:absolute;bottom:4px;width:100%;display:flex;justify-content:center;gap:2px;flex-wrap:wrap;padding:0 4px;
    }
    .token{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(0,0,0,0.5);
      box-shadow:0 2px 4px rgba(0,0,0,0.5);
      transition:transform 0.2s;
    }
    .token.p1{background:var(--p1);}
    .token.p2{background:var(--p2);}
    .token.p3{background:var(--p3);}
    .token.p4{background:var(--p4);}
    .token.active{transform:translateY(-4px) scale(1.2);border-color:#fff;}

    /* Controls */
    .controls{display:flex;flex-direction:column;gap:12px;}
    .dice-area{
      min-height:100px;background:rgba(0,0,0,0.3);border-radius:12px;
      display:flex;align-items:center;justify-content:center;gap:10px;padding:10px;
    }
    .die{
      width:56px;height:56px;background:#fff;border-radius:12px;
      display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);
      padding:6px;gap:2px;
      box-shadow:0 4px 8px rgba(0,0,0,0.3);
      cursor:pointer;position:relative;
      transition:transform 0.1s;
    }
    .die.held{transform:translateY(4px);filter:brightness(0.8);box-shadow:inset 0 0 0 3px var(--ok);}
    .die.rolling{animation:shake 0.5s infinite;}
    @keyframes shake{
      0%{transform:rotate(0deg)} 25%{transform:rotate(5deg)} 50%{transform:rotate(0deg)} 75%{transform:rotate(-5deg)} 100%{transform:rotate(0deg)}
    }
    .pip{background:#333;border-radius:50%;}
    
    .btn-group{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    button{
      padding:12px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;
      background:rgba(255,255,255,0.1);color:var(--text);border:1px solid var(--line);
      transition:background 0.2s;
    }
    button:disabled{opacity:0.4;cursor:not-allowed;}
    button.primary{background:var(--accent);color:#fff;border:none;}
    button.success{background:var(--ok);color:#000;border:none;}
    button:not(:disabled):hover{filter:brightness(1.1);}

    /* Info Areas */
    .info-box{background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;font-size:13px;line-height:1.4;min-height:60px;}
    .player-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:auto;}
    .p-card{
      padding:8px;border-radius:6px;background:rgba(255,255,255,0.03);border:1px solid var(--line);
      display:flex;flex-direction:column;gap:4px;
    }
    .p-card.active{background:rgba(255,255,255,0.08);border-color:var(--text);}
    .pc-name{font-size:12px;font-weight:bold;display:flex;align-items:center;gap:6px;}
    .pc-dot{width:8px;height:8px;border-radius:50%;}
    .pc-stats{font-size:11px;color:var(--muted);display:flex;justify-content:space-between;}

    /* Modal */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);
      display:none;justify-content:center;align-items:center;z-index:999;
    }
    .modal{
      width:min(500px, 90%);background:#1f151a;border:1px solid var(--line);border-radius:16px;
      padding:24px;box-shadow:0 20px 50px rgba(0,0,0,0.7);text-align:center;
      max-height: 90vh; overflow-y: auto;
    }
    .modal h2{margin-top:0;color:var(--gold);}
    .modal p{color:var(--text);line-height:1.5;margin-bottom:20px;}
    .card-visual{
      width:120px;height:160px;background:#333;margin:0 auto 16px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid var(--gold);
      box-shadow:0 10px 20px rgba(0,0,0,0.3);
      flex-direction:column; gap:8px; padding:10px;
    }
    
    .rules-list {text-align:left; font-size:13px; color:var(--text); line-height:1.6; margin-bottom:20px; background:rgba(0,0,0,0.2); padding:15px; border-radius:8px;}
    .rules-list li {margin-bottom:8px;}
    .rules-list strong {color:var(--gold);}

    /* Setup */
    .setup-options{text-align:left;display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
    .setup-options label{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;}
    .setup-options input{transform:scale(1.2);}

    /* Utility */
    .hidden{display:none !important;}
    .text-gold{color:var(--gold);}
    .text-red{color:var(--accent);}
    .text-green{color:var(--ok);}
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <h1>ë˜ì „ ë‹¤ì´ìŠ¤</h1>
      <button id="rulesBtn" style="padding:4px 8px; font-size:12px;">?</button>
    </div>
    <div class="status-badge" id="turnBadge">ì„¤ì • ëŒ€ê¸°</div>
  </header>

  <div class="main-grid">
    <!-- Game Board -->
    <div class="panel">
      <div class="panel-hd">
        <span>ë˜ì „ ì§€ë„ (5x5)</span>
        <span id="mapInfo">START: (3,3)</span>
      </div>
      <div class="board-container">
        <div class="board" id="board">
          <!-- Tiles generated by JS -->
        </div>
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--muted);text-align:center;">
        * 13ë¼ìš´ë“œ ì œí•œ | ë‘ê±´ í•´ì œ: í•© 10â†‘<br>
        * ëª¬ìŠ¤í„° íŒ¨ë°° ì‹œ ë’¤ë¡œ ì´ë™ | EXIT ì¡±ë³´ ë§Œì¡± ì‹œ íƒˆì¶œ
      </div>
    </div>

    <!-- Controls & Info -->
    <div class="controls">
      <!-- Action Panel -->
      <div class="panel" style="flex:0 0 auto;">
        <div class="panel-hd">
          <span>ì£¼ì‚¬ìœ„ ì»¨íŠ¸ë¡¤</span>
          <span id="rollCount">ë‚¨ì€ êµ´ë¦¼: -</span>
        </div>
        
        <div class="info-box" id="gameLog">
          ê²Œì„ì„ ì„¤ì •í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.
        </div>

        <div class="dice-area" id="diceArea">
          <!-- Dice -->
        </div>

        <div class="btn-group" style="margin-top:12px;">
          <button id="rollBtn" class="primary" disabled>êµ´ë¦¬ê¸°</button>
          <button id="stopBtn" disabled>í™•ì •/í–‰ë™</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;">
           <button id="endTurnBtn" style="flex:1" disabled>í„´ ì¢…ë£Œ</button>
           <button id="setupBtn" style="width:40px;"âš™ï¸</button>
        </div>
      </div>

      <!-- Player Status -->
      <div class="panel" style="flex:1;">
        <div class="panel-hd">í”Œë ˆì´ì–´ í˜„í™© (ìµœëŒ€ 13R)</div>
        <div class="player-cards" id="playerList">
          <!-- Dynamic Player Cards -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Setup Modal -->
<div class="modal-overlay" id="setupModal" style="display:flex;">
  <div class="modal">
    <h2>ê²Œì„ ì„¤ì •</h2>
    <div class="setup-options">
      <label><input type="radio" name="pCount" value="2-ai" checked> 2ì¸ (Player vs AI)</label>
      <label><input type="radio" name="pCount" value="2"> 2ì¸ í”Œë ˆì´ (1:1)</label>
      <label><input type="radio" name="pCount" value="3"> 3ì¸ í”Œë ˆì´</label>
      <label><input type="radio" name="pCount" value="4"> 4ì¸ í”Œë ˆì´</label>
    </div>
    <button class="primary" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
  </div>
</div>

<!-- Rules Modal -->
<div class="modal-overlay" id="rulesModal">
  <div class="modal">
    <h2>ê²Œì„ ê·œì¹™</h2>
    <div class="rules-list">
      <ul>
        <li><strong>ìŠ¹ë¦¬ ì¡°ê±´:</strong> 13ë¼ìš´ë“œ ë‚´ì— íƒˆì¶œí•˜ê³  ê°€ì¥ ë†’ì€ ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”. (íƒˆì¶œ ì‹œ +10ì )</li>
        <li><strong>ë‘ê±´(Blindfold):</strong> ì‹œì‘ ì‹œ ëˆˆì´ ê°€ë ¤ì ¸ ìˆìŠµë‹ˆë‹¤. ì²« ì£¼ì‚¬ìœ„ êµ´ë¦¼ í•©ì´ <strong>10 ì´ìƒ</strong>ì´ì–´ì•¼ í’€ë¦¬ê³  ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li><strong>ì´ë™:</strong> íƒ€ì¼ì˜ ì¡±ë³´ë¥¼ ì£¼ì‚¬ìœ„ë¡œ ë§Œì¡±í•´ì•¼ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: 3 of a Kind = ê°™ì€ ìˆ«ì 3ê°œ)</li>
        <li><strong>íƒ€ì¼ ì •ì›:</strong> 2ì¸ ê²Œì„ì€ íƒ€ì¼ë‹¹ 1ëª…, 3ì¸+ ê²Œì„ì€ 2ëª…ê¹Œì§€ë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li><strong>ëª¬ìŠ¤í„°:</strong> ì „íˆ¬ì—ì„œ íŒ¨ë°°(í•© 15 ë¯¸ë§Œ)í•˜ë©´ <strong>ì´ì „ ì¹¸ìœ¼ë¡œ 1ì¹¸ í›„í‡´</strong>í•©ë‹ˆë‹¤.</li>
        <li><strong>ê²Œì„ ì¢…ë£Œ:</strong> ëˆ„êµ°ê°€ íƒˆì¶œí•˜ê±°ë‚˜, ëª¨ë“  í”Œë ˆì´ì–´ê°€ 13ë¼ìš´ë“œë¥¼ ë§ˆì¹˜ë©´ ì¢…ë£Œë©ë‹ˆë‹¤.</li>
      </ul>
    </div>
    <button class="success" onclick="document.getElementById('rulesModal').style.display='none'" style="width:100%">ë‹«ê¸°</button>
  </div>
</div>

<!-- Event Modal -->
<div class="modal-overlay" id="eventModal">
  <div class="modal">
    <h2 id="evtTitle">ì´ë²¤íŠ¸</h2>
    <div class="card-visual" id="evtCard">
      <span>?</span>
    </div>
    <p id="evtDesc">ë‚´ìš©</p>
    <div id="evtActions" class="btn-group hidden">
      <button class="primary" id="evtRollBtn">ë„ì „ êµ´ë¦¼</button>
    </div>
    <button class="success" id="evtCloseBtn" style="margin-top:10px; width:100%;">í™•ì¸</button>
  </div>
</div>

<script>
/**
 * Dungeon Dice Web Logic
 * Updated: AI Mode, Monster Penalty, 13 Round Limit
 */

// --- Data & Config ---
const CATS = {
  threeKind: "3 of a Kind", fourKind: "4 of a Kind", 
  fullHouse: "Full House", chance: "Chance",
  highSum: "Sum 25â†‘", lowSum: "Sum 7â†“",
  ones: "Ones (1)", twos: "Twos (2)", threes: "Threes (3)", 
  fours: "Fours (4)", fives: "Fives (5)", sixes: "Sixes (6)",
  smallStr: "S. Straight", largeStr: "L. Straight", yacht: "Yacht"
};

const EXIT_POOL = ['fullHouse', 'fourKind', 'highSum', 'lowSum', 'largeStr', 'yacht'];
const P_COLORS = ["var(--p1)", "var(--p2)", "var(--p3)", "var(--p4)"];
const MAX_ROUNDS = 13;

// Game State
let state = {
  players: [],
  activeIdx: 0,
  phase: 'setup', 
  mode: 'pvp', // 'pvp' or 'ai'
  board: [],
  dice: [1,1,1,1,1],
  held: [false,false,false,false,false],
  rollsLeft: 3,
  playerCount: 2
};

const START_POS = {x:3, y:3};
function toIdx(x,y) { return (y-1)*5 + (x-1); }
function toXY(idx) { return {x:(idx%5)+1, y:Math.floor(idx/5)+1}; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// --- Initialization ---

function startGame(){
  const val = document.querySelector('input[name="pCount"]:checked').value;
  
  if(val === '2-ai'){
    state.playerCount = 2;
    state.mode = 'ai';
  } else {
    state.playerCount = parseInt(val);
    state.mode = 'pvp';
  }
  
  state.players = [];
  for(let i=0; i<state.playerCount; i++){
    state.players.push({
      id: i,
      name: (state.mode === 'ai' && i===1) ? "AI (P2)" : `P${i+1}`,
      x: START_POS.x, y: START_POS.y,
      prevX: START_POS.x, prevY: START_POS.y, // Track previous position
      isLocked: true, 
      score: 0,
      rerollTokens: 0,
      escaped: false,
      failed: false,
      turns: 0 // Track rounds
    });
  }

  generateBoard();
  document.getElementById('setupModal').style.display = 'none';
  state.activeIdx = 0;
  startTurn();
}

function generateBoard(){
  const deck = [];
  for(let i=0; i<6; i++) deck.push('threeKind'); // Common
  deck.push('fourKind', 'fourKind', 'highSum', 'lowSum'); // Uncommon
  deck.push('fullHouse', 'fullHouse', 'yacht'); // Reward
  deck.push('chance', 'chance'); // Gambit
  deck.push('smallStr', 'largeStr'); // Rare
  const numbers = ['ones', 'twos', 'threes', 'fours', 'fives', 'sixes'];
  for(let i=0; i<3; i++) deck.push(numbers[Math.floor(Math.random()*numbers.length)]); // Blockers

  for (let i = deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }

  state.board = new Array(25).fill(null);
  const startIdx = toIdx(START_POS.x, START_POS.y);
  const exits = [0, 4, 20, 24]; 
  
  state.board[startIdx] = { cat: 'chance', isExit: false }; 
  exits.forEach(idx => {
    const hardCat = EXIT_POOL[Math.floor(Math.random() * EXIT_POOL.length)];
    state.board[idx] = { cat: hardCat, isExit: true };
  });

  let deckPtr = 0;
  for(let i=0; i<25; i++){
    if(state.board[i]) continue; 
    state.board[i] = { cat: deck[deckPtr++], isExit: false };
  }

  renderBoard();
  updatePlayerList();
}

// --- Core Game Loop ---

function startTurn(){
  const p = currentPlayer();
  
  // Game Over Check
  if(state.players.every(pl => pl.escaped || pl.turns >= MAX_ROUNDS)){
    endGame();
    return;
  }
  
  // Skip if done
  if(p.escaped || p.failed){
    nextPlayer();
    return;
  }
  
  // Round Limit Check
  if(p.turns >= MAX_ROUNDS){
    p.failed = true;
    log(`${p.name}: 13ë¼ìš´ë“œ ì¢…ë£Œ. íƒˆì¶œ ì‹¤íŒ¨!`);
    updatePlayerList();
    setTimeout(nextPlayer, 1500);
    return;
  }

  state.dice = [1,1,1,1,1];
  state.held = [false,false,false,false,false];
  
  if(p.isLocked){
    state.phase = 'lockedRoll';
    state.rollsLeft = 1;
    log(`${p.name} (R${p.turns+1}): ë‘ê±´ ìƒíƒœ. í•´ì œí•˜ë ¤ë©´ í•© 10 ì´ìƒ í•„ìš”.`);
  } else {
    state.phase = 'roll';
    state.rollsLeft = 3;
    log(`${p.name} (R${p.turns+1}): ì´ë™í•  ê³³ì„ ìœ„í•´ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì„¸ìš”.`);
  }

  updateUI();

  // AI Turn Trigger
  if(state.mode === 'ai' && p.id === 1){
    setTimeout(playAITurn, 1000);
  }
}

function nextPlayer(){
  // Increment turn count for current player before switching
  const p = currentPlayer();
  if(!p.escaped && !p.failed) p.turns++;
  
  state.activeIdx = (state.activeIdx + 1) % state.playerCount;
  startTurn();
}

// --- Player Actions ---

function rollDice(){
  if(state.mode === 'ai' && state.activeIdx === 1) return; // Block human interaction during AI
  performRoll();
}

function performRoll(){
  if(state.rollsLeft <= 0) return;
  const p = currentPlayer();
  
  const dieEls = document.querySelectorAll('.die');
  dieEls.forEach((el,i) => {
    if(!state.held[i]) el.classList.add('rolling');
  });

  setTimeout(() => {
    for(let i=0; i<5; i++){
      if(!state.held[i]) state.dice[i] = Math.ceil(Math.random()*6);
    }
    dieEls.forEach(el => el.classList.remove('rolling'));
    state.rollsLeft--;

    // Auto-check Locked state
    if(state.phase === 'lockedRoll'){
      const sum = state.dice.reduce((a,b)=>a+b, 0);
      if(sum >= 10){
        p.isLocked = false;
        log(`<span class="text-green">ì„±ê³µ! (í•© ${sum})</span> ë‘ê±´ í•´ì œ! ë‹¤ìŒ í„´ë¶€í„° ì´ë™ ê°€ëŠ¥.`);
        // Locked success ends turn immediately in standard rules, OR allow immediate move?
        // Rule says "immediately move". Let's give 3 rolls.
        state.phase = 'roll';
        state.rollsLeft = 3; 
        state.held = [false,false,false,false,false];
      } else {
        log(`<span class="text-red">ì‹¤íŒ¨.. (í•© ${sum})</span> í•´ì œ ì‹¤íŒ¨. í„´ ì¢…ë£Œ.`);
        state.phase = 'end';
        if(state.mode === 'ai' && p.id === 1) setTimeout(nextPlayer, 1500);
      }
    }
    updateUI();
  }, 500);
}

function confirmDice(){
  if(state.phase !== 'roll') return;
  
  const possibleMoves = getMovableTiles();
  if(possibleMoves.length === 0){
    log(`ì´ë™ ê°€ëŠ¥í•œ íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤. í„´ì„ ì¢…ë£Œí•˜ì„¸ìš”.`);
    state.phase = 'end';
    if(state.mode === 'ai' && currentPlayer().id === 1) setTimeout(nextPlayer, 1500);
  } else {
    state.phase = 'move';
    log(`ì´ë™í•  íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”.`);
    renderBoard();
    
    // AI Move Logic handled in playAITurn flow
  }
  updateUI();
}

function getMovableTiles(){
  const p = currentPlayer();
  const moves = [];
  const neighbors = [
    {x:p.x, y:p.y-1}, {x:p.x, y:p.y+1}, {x:p.x-1, y:p.y}, {x:p.x+1, y:p.y}
  ];

  neighbors.forEach(n => {
    if(n.x<1 || n.x>5 || n.y<1 || n.y>5) return;
    const idx = toIdx(n.x, n.y);
    const tile = state.board[idx];
    
    const occupants = state.players.filter(pl => !pl.escaped && pl.x === n.x && pl.y === n.y).length;
    const limit = state.playerCount === 2 ? 1 : 2;
    if(occupants >= limit) return;

    if(checkMatch(tile.cat, state.dice)) moves.push(idx);
  });
  return moves;
}

function movePlayer(idx){
  if(state.phase !== 'move') return;
  const moves = getMovableTiles();
  if(!moves.includes(idx)) return;

  const p = currentPlayer();
  // Save previous position
  p.prevX = p.x;
  p.prevY = p.y;
  
  // Update position
  const pos = toXY(idx);
  p.x = pos.x;
  p.y = pos.y;
  
  renderBoard();
  handleTileEvent(state.board[idx]);
}

// --- AI Logic ---

async function playAITurn(){
  const p = currentPlayer();
  if(p.id !== 1) return;

  // 1. Locked Phase
  if(state.phase === 'lockedRoll'){
    await sleep(500);
    performRoll(); // Will handle success/fail internally
    // If unlocked, it switches to 'roll'. Wait loop handles state change.
    await sleep(1000);
    if(state.phase === 'end') return; // Failed unlock
  }

  // 2. Roll Phase
  if(state.phase === 'roll'){
    // Decide Target
    let targetIdx = -1;
    let targetCat = 'chance';
    
    // Scan neighbors
    const neighbors = [
      {x:p.x, y:p.y-1}, {x:p.x, y:p.y+1}, {x:p.x-1, y:p.y}, {x:p.x+1, y:p.y}
    ].filter(n => n.x>=1 && n.x<=5 && n.y>=1 && n.y<=5);
    
    // Simple Heuristic: Exit > Action/Item > Move
    let bestScore = -1;
    
    for(let n of neighbors){
      const idx = toIdx(n.x, n.y);
      const tile = state.board[idx];
      // Check occupancy
      const occupants = state.players.filter(pl => !pl.escaped && pl.x === n.x && pl.y === n.y).length;
      if(occupants >= 1) continue; // Assume 2p limit

      let score = 1;
      if(tile.isExit) score = 10;
      else if(['yacht','fullHouse','fourKind'].includes(tile.cat)) score = 5;
      else if(['highSum','lowSum'].includes(tile.cat)) score = 3;
      
      if(score > bestScore){
        bestScore = score;
        targetIdx = idx;
        targetCat = tile.cat;
      }
    }

    log(`AI ëª©í‘œ: ${CATS[targetCat] || targetCat} ë…¸ë¦¬ê¸°...`);

    // Roll Loop
    while(state.rollsLeft > 0){
      await sleep(800);
      
      // Auto Hold Logic
      const newHeld = getAIHeldDice(targetCat, state.dice);
      state.held = newHeld;
      updateUI(); // Show held status
      
      await sleep(500);
      performRoll(); // Decrements rollsLeft
      
      // Check if match found already?
      if(checkMatch(targetCat, state.dice) && targetIdx !== -1){
        break; // Stop rolling if we got it
      }
    }
    
    await sleep(800);
    confirmDice(); // Logic checks moves. AI might have failed target but got something else.
    
    await sleep(800);
    if(state.phase === 'move'){
      // Find best move from actual valid moves
      const validMoves = getMovableTiles();
      // Prefer originally targeted index if valid
      if(validMoves.includes(targetIdx)){
        movePlayer(targetIdx);
      } else if(validMoves.length > 0){
        movePlayer(validMoves[0]); // Random fallback
      }
    } else {
      setTimeout(nextPlayer, 1000); // No moves, end turn
    }
  }
}

function getAIHeldDice(cat, dice){
  const held = [false,false,false,false,false];
  const counts = {};
  dice.forEach(d => counts[d] = (counts[d]||0)+1);
  
  // Basic strategy
  if(['threeKind','fourKind','yacht','fullHouse'].includes(cat)){
    // Hold most frequent
    let maxFreq = 0, targetNum = 0;
    for(let k in counts){
      if(counts[k] > maxFreq){ maxFreq=counts[k]; targetNum=parseInt(k); }
    }
    dice.forEach((d,i) => { if(d===targetNum) held[i]=true; });
  } else if(cat === 'highSum'){
    dice.forEach((d,i) => { if(d>=5) held[i]=true; });
  } else if(cat === 'lowSum'){
    dice.forEach((d,i) => { if(d<=2) held[i]=true; });
  } 
  // Else (Straights, Chance, etc) -> Hold nothing or random (Keep simple)
  return held;
}

// --- Event Handling ---

function handleTileEvent(tile){
  const p = currentPlayer();
  
  if(tile.isExit){
    p.escaped = true;
    p.score += 10; 
    log(`ğŸ‰ <span class="text-gold">${p.name} íƒˆì¶œ ì„±ê³µ!</span> (+10ì )`);
    if(checkGameOver()) endGame();
    else {
      state.phase = 'end';
      updateUI();
      if(state.mode==='ai' && p.id===1) setTimeout(nextPlayer, 1500);
    }
    return;
  }

  // Trigger Cards
  if(['fourKind', 'fullHouse', 'smallStr', 'largeStr', 'highSum', 'lowSum'].includes(tile.cat)){
    triggerEvent('action', tile.cat);
  } else if(tile.cat === 'yacht'){
    triggerEvent('item', 'yacht');
  } else if(tile.cat === 'chance'){
    triggerEvent('chance', 'chance');
  } else {
    // Normal Move
    log(`${p.name} ì´ë™ ì™„ë£Œ.`);
    state.phase = 'end';
    updateUI();
    if(state.mode==='ai' && p.id===1) setTimeout(nextPlayer, 1500);
  }
}

function triggerEvent(type, cat){
  const p = currentPlayer();
  const isAI = (state.mode === 'ai' && p.id === 1);

  // If AI, don't show modal, just auto resolve logic
  if(isAI){
    log(`AI: ì´ë²¤íŠ¸ ë°œìƒ! (${type}) ì£¼ì‚¬ìœ„ êµ´ë¦¬ëŠ” ì¤‘...`);
    setTimeout(() => {
        if(type === 'item'){
           p.rerollTokens++; p.score+=1; 
           log(`AI: ì•„ì´í…œ íšë“.`);
           state.phase='end'; updateUI(); setTimeout(nextPlayer, 1000);
        } else if(type === 'action'){
           if(Math.random()>0.6) { // Gold
             p.score+=1; log("AI: ê¸ˆë©ì–´ë¦¬ ë°œê²¬ (+1ì )");
             state.phase='end'; updateUI(); setTimeout(nextPlayer, 1000);
           } else { // Monster
             resolveEventRoll(15, 'monster');
           }
        } else if(type === 'chance'){
           resolveEventRoll(20, 'chance');
        }
    }, 1500);
    return;
  }

  // Human UI
  const modal = document.getElementById('eventModal');
  const title = document.getElementById('evtTitle');
  const desc = document.getElementById('evtDesc');
  const card = document.getElementById('evtCard');
  const actBtns = document.getElementById('evtActions');
  const closeBtn = document.getElementById('evtCloseBtn');
  
  modal.style.display = 'flex';
  actBtns.classList.add('hidden');
  closeBtn.style.display = 'none'; 

  if(type === 'item'){
    title.innerText = "ì•„ì´í…œ ë°œê²¬!";
    card.innerHTML = `<span style="font-size:40px">ğŸ’Š</span><div>ë¦¬ë¡¤ í† í°</div>`;
    desc.innerHTML = `Yacht ë‹¬ì„±! <b>ë¦¬ë¡¤ í† í°</b>ì„ íšë“í•©ë‹ˆë‹¤.`;
    p.rerollTokens++;
    p.score += 1;
    closeBtn.style.display = 'block'; 
  } 
  else if (type === 'action') {
    const isGold = Math.random() > 0.6; 
    title.innerText = "ì•¡ì…˜ ì¹´ë“œ";
    if(isGold){
      card.innerHTML = `<span style="font-size:40px; color:gold;">ğŸ’°</span><div>ê¸ˆë©ì–´ë¦¬</div>`;
      desc.innerHTML = `ê¸ˆë©ì–´ë¦¬ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!<br><b>ì ìˆ˜ +1</b>`;
      p.score += 1;
      closeBtn.style.display = 'block';
    } else {
      card.innerHTML = `<span style="font-size:40px">ğŸ˜ˆ</span><div>ëª¬ìŠ¤í„°</div>`;
      desc.innerHTML = `ëª¬ìŠ¤í„°ì™€ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤!<br><b>í•© 15 ì´ìƒ</b> ìŠ¹ë¦¬ / <b>íŒ¨ë°° ì‹œ í›„í‡´</b>`;
      actBtns.classList.remove('hidden');
      document.getElementById('evtRollBtn').onclick = () => {
        resolveEventRoll(15, 'monster');
      };
    }
  }
  else if (type === 'chance') {
    title.innerText = "ìš´ ì‹œí—˜";
    card.innerHTML = `<span style="font-size:40px">ğŸ²</span><div>ì°¬ìŠ¤</div>`;
    desc.innerHTML = `ìš´ì„ ì‹œí—˜í•©ë‹ˆë‹¤.<br>í•© 20 ì´ìƒ ëŒ€ë°•(+2), ì‹¤íŒ¨ ì‹œ <b>ì‹œì‘ì ìœ¼ë¡œ</b>.`;
    actBtns.classList.remove('hidden');
    document.getElementById('evtRollBtn').onclick = () => {
      resolveEventRoll(20, 'chance');
    };
  }
}

function resolveEventRoll(target, type){
  const roll = Array.from({length:5}, ()=>Math.ceil(Math.random()*6));
  const sum = roll.reduce((a,b)=>a+b,0);
  const p = currentPlayer();
  
  const desc = document.getElementById('evtDesc');
  const actBtns = document.getElementById('evtActions');
  const closeBtn = document.getElementById('evtCloseBtn');
  
  if(! (state.mode==='ai' && p.id===1) ){
    actBtns.classList.add('hidden');
    closeBtn.style.display = 'block';
  }
  
  let msg = `ê²°ê³¼: <b>[${roll.join(',')}]</b> (í•© ${sum})<br>`;
  
  if(sum >= target){
    msg += `<span class="text-green">ì„±ê³µ!</span> `;
    if(type === 'monster') { msg += `ëª¬ìŠ¤í„° ì²˜ì¹˜ (+2ì )`; p.score += 2; }
    if(type === 'chance') { msg += `ëŒ€ë°• ì°¬ìŠ¤! (+2ì )`; p.score += 2; }
  } else {
    msg += `<span class="text-red">ì‹¤íŒ¨...</span> `;
    if(type === 'monster') { 
        msg += `ë„ë§ì¹©ë‹ˆë‹¤ (ë’¤ë¡œ ì´ë™).`; 
        // Monster Penalty: Move Back
        p.x = p.prevX; p.y = p.prevY;
        renderBoard();
    }
    if(type === 'chance') { 
      msg += `ì‹œì‘ ì§€ì ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.`; 
      p.x = START_POS.x; p.y = START_POS.y;
      renderBoard();
    }
  }
  
  if(state.mode === 'ai' && p.id === 1){
    log(`AI: ${msg}`);
    state.phase = 'end';
    updateUI();
    setTimeout(nextPlayer, 1500);
  } else {
    desc.innerHTML = msg;
    state.phase = 'end';
    updateUI();
    updatePlayerList();
  }
}


// --- Logic ---

function checkMatch(cat, dice){
  const counts = {};
  let sum = 0;
  dice.forEach(d => {
    counts[d] = (counts[d]||0)+1;
    sum += d;
  });
  
  const vals = Object.values(counts);
  const maxCount = Math.max(...vals);

  switch(cat){
    case 'ones': return counts[1]>=1;
    case 'twos': return counts[2]>=1;
    case 'threes': return counts[3]>=1;
    case 'fours': return counts[4]>=1;
    case 'fives': return counts[5]>=1;
    case 'sixes': return counts[6]>=1;
    case 'threeKind': return maxCount >= 3;
    case 'fourKind': return maxCount >= 4;
    case 'yacht': return maxCount === 5;
    case 'fullHouse': return (vals.includes(3) && vals.includes(2)) || maxCount===5;
    case 'smallStr': 
      // Simplified string check
      const u = Object.keys(counts).map(Number).sort((a,b)=>a-b).join('');
      return (u.includes('1234') || u.includes('2345') || u.includes('3456'));
    case 'largeStr': 
      const u2 = Object.keys(counts).map(Number).sort((a,b)=>a-b).join('');
      return (u2.includes('12345') || u2.includes('23456'));
    case 'chance': return true;
    case 'highSum': return sum >= 25;
    case 'lowSum': return sum <= 7;
    default: return false;
  }
}

function currentPlayer(){ return state.players[state.activeIdx]; }
function log(msg){ document.getElementById('gameLog').innerHTML = msg; }
function checkGameOver(){ 
  // Game over if ALL players are either escaped OR failed (reached 13 rounds)
  return state.players.every(p => p.escaped || p.failed); 
}

function endGame(){
  state.phase = 'end';
  const sorted = [...state.players].sort((a,b) => b.score - a.score);
  const winner = sorted[0];
  
  let html = `<h3>ğŸ† ê²Œì„ ì¢…ë£Œ! ğŸ†</h3>`;
  if(winner.escaped){
      html += `<b>ìš°ìŠ¹: ${winner.name} (${winner.score}ì )</b><br>`;
  } else {
      html += `<b>ìƒì¡´ì ì—†ìŒ (ì „ì› ì‹¤íŒ¨)</b><br>`;
  }
  
  html += `<br>ìˆœìœ„:<br>`;
  sorted.forEach((p,i) => {
    const status = p.escaped ? "(íƒˆì¶œ)" : "(ì‚¬ë§/ì‹¤íŒ¨)";
    html += `${i+1}ìœ„: ${p.name} - ${p.score}ì  ${status}<br>`;
  });
  
  log(html);
  document.getElementById('rollBtn').disabled = true;
  document.getElementById('endTurnBtn').disabled = true;
  document.getElementById('stopBtn').disabled = true;
}

// --- UI Rendering ---

function updateUI(){
  const p = currentPlayer();
  
  // Dice
  const diceArea = document.getElementById('diceArea');
  diceArea.innerHTML = '';
  state.dice.forEach((val, i) => {
    const die = document.createElement('div');
    die.className = `die ${state.held[i] ? 'held' : ''}`;
    const pipPos = {
      1: [4], 2:[0,8], 3:[0,4,8], 4:[0,2,6,8], 5:[0,2,4,6,8], 6:[0,2,3,5,6,8]
    };
    for(let k=0; k<9; k++){
      const pip = document.createElement('div');
      if(pipPos[val].includes(k)) pip.className = 'pip';
      die.appendChild(pip);
    }
    die.onclick = () => {
      // Human interaction check
      if(state.mode === 'ai' && p.id === 1) return;
      if(state.phase === 'roll'){
        state.held[i] = !state.held[i];
        updateUI();
      }
    };
    diceArea.appendChild(die);
  });

  // Buttons
  const rollBtn = document.getElementById('rollBtn');
  const stopBtn = document.getElementById('stopBtn');
  const endBtn = document.getElementById('endTurnBtn');
  
  document.getElementById('rollCount').innerText = `ë‚¨ì€ êµ´ë¦¼: ${state.rollsLeft}`;
  document.getElementById('turnBadge').innerHTML = `${p.name} (R${Math.min(p.turns+1, 13)})`;
  document.getElementById('turnBadge').style.color = P_COLORS[p.id];
  
  rollBtn.disabled = true;
  stopBtn.disabled = true;
  endBtn.disabled = true;

  // AI disables buttons
  const isAI = (state.mode === 'ai' && p.id === 1);

  if((state.phase === 'roll' || state.phase === 'lockedRoll') && !isAI){
    if(state.rollsLeft > 0) rollBtn.disabled = false;
    if(state.phase === 'roll') stopBtn.disabled = false;
  }
  if(state.phase === 'end' && !isAI) endBtn.disabled = false;

  updatePlayerList();
}

function updatePlayerList(){
  const list = document.getElementById('playerList');
  list.innerHTML = '';
  state.players.forEach(p => {
    const card = document.createElement('div');
    card.className = `p-card ${p.id === state.activeIdx ? 'active' : ''}`;
    let status = p.escaped ? "ğŸ†íƒˆì¶œ" : (p.isLocked ? "ğŸ”’ë¬¶ì„" : "ğŸ”“ì´ë™");
    if(p.failed) status = "ğŸ’€ì‹¤íŒ¨";
    
    card.innerHTML = `
      <div class="pc-name">
        <div class="pc-dot" style="background:${P_COLORS[p.id]}"></div>
        ${p.name} ${p.id === state.activeIdx ? 'â—€' : ''}
      </div>
      <div class="pc-stats">
        <span>ì ìˆ˜: ${p.score}</span>
        <span>${status}</span>
      </div>
      <div class="pc-stats" style="font-size:10px; opacity:0.7">
        í„´: ${p.turns}/${MAX_ROUNDS} | T: ${p.rerollTokens}
      </div>
    `;
    list.appendChild(card);
  });
}

function renderBoard(){
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';
  const moves = (state.phase === 'move') ? getMovableTiles() : [];

  state.board.forEach((tile, idx) => {
    const el = document.createElement('div');
    el.className = `tile ${tile.isExit ? 'exit' : ''}`;
    if(idx === toIdx(START_POS.x, START_POS.y)) el.classList.add('start');
    if(moves.includes(idx)) el.classList.add('movable');
    
    let name = CATS[tile.cat] || tile.cat;
    if(tile.isExit) name = `EXIT<br><span style="font-size:9px;color:var(--gold)">${name}</span>`;
    else if(idx === toIdx(START_POS.x, START_POS.y)) name = "START";
    
    el.innerHTML = `
      <div class="t-label">${toXY(idx).x},${toXY(idx).y}</div>
      <div class="t-name">${name}</div>
      <div class="t-tokens"></div>
    `;

    state.players.forEach(p => {
      if(!p.escaped && toIdx(p.x, p.y) === idx){
        const tok = document.createElement('div');
        tok.className = `token p${p.id+1} ${p.id===state.activeIdx ? 'active':''}`;
        // If Failed, make semi-transparent
        if(p.failed) tok.style.opacity = "0.3";
        el.querySelector('.t-tokens').appendChild(tok);
      }
    });

    el.onclick = () => movePlayer(idx);
    boardEl.appendChild(el);
  });
}

// Event Bindings
document.getElementById('rollBtn').onclick = rollDice;
document.getElementById('stopBtn').onclick = confirmDice;
document.getElementById('endTurnBtn').onclick = nextPlayer;
document.getElementById('setupBtn').onclick = () => document.getElementById('setupModal').style.display='flex';
document.getElementById('rulesBtn').onclick = () => document.getElementById('rulesModal').style.display='flex';
document.getElementById('evtCloseBtn').onclick = () => document.getElementById('eventModal').style.display='none';

</script>
</body>
</html>
